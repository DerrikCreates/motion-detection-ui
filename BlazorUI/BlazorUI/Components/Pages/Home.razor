@page "/"
@using System.ComponentModel.DataAnnotations
@using Emgu.CV
@using LiteDB
@using VideoProcessing
@using MotionHistory = MotionHistory
@rendermode InteractiveServer
@inject ILiteCollection<StreamConfig> StreamConfigDb;
@inject ILiteCollection<MotionHistory> HistoryDb;
<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<button @onclick="Test"></button>
<EditForm Model="@Model" OnValidSubmit="OnValidSubmit" FormName="StartMotionDetection">
    <DataAnnotationsValidator/>
    <ValidationSummary/>
    <div class="mb-3">
        <label>Stream Name</label>
        <InputText class="form-control" @bind-Value="Model.StreamName"/>
    </div>
    <div class="mb-3">
        <label>Stream URL</label>
        <InputText class="form-control" @bind-Value="Model.StreamUrl"/>
    </div>
    <div class="mb-3">
        <label>Frames to skip</label>
        <InputNumber class="form-control" @bind-Value="Model.FramesToSkip"/>
    </div>
    <div class="mb-3">
        <label>MOG History</label>
        <InputNumber class="form-control" @bind-Value="Model.MOGHistory"/>
    </div>
    <div class="mb-3">
        <label>MOG Threshold</label>
        <InputNumber class="form-control" @bind-Value="Model.MOGThreshold"/>
    </div>
    <div class="mb-3">
        <label>Threshold Min</label>
        <InputNumber class="form-control" @bind-Value="Model.ThresholdMin"/>
    </div>
    <div class="mb-3">
        <label>Threshold Max</label>
        <InputNumber class="form-control" @bind-Value="Model.ThresholdMax"/>
    </div>
    <button type="submit">Submit</button>
</EditForm>

@code{


    [SupplyParameterFromForm] private StreamConfig? Model { get; set; } = new();

    private void Test()
    {
    }


    private void OnValidSubmit()
    {
        StreamConfigDb.Upsert(Model);


        Task.Run(() =>
        {
            var capture = new VideoCapture(Model.StreamUrl, VideoCapture.API.Ffmpeg);
            return VideoProcessor.StreamMotionDetectionCUDA(capture, Model, new CancellationToken(), collection: HistoryDb);
        });
    }

}
    
    
    
    